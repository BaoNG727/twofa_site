{% extends "base.html" %}

{% block title %}VOZ - Forums{% endblock %}

{% block content %}
<div class="container" style="margin-top: var(--space-6); margin-bottom: var(--space-8);">
    
    <!-- Quick Actions Bar -->
    {% if not request.user.is_authenticated %}
    <div class="card" style="background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-700) 100%); color: white; margin-bottom: var(--space-4); border: none;">
        <div style="padding: var(--space-4) var(--space-5); display: flex; align-items: center; justify-content: space-between; gap: var(--space-4);">
            <div>
                <div style="font-size: var(--text-lg); font-weight: 600; margin-bottom: 4px; color: white;">
                    üëã Ch√†o m·ª´ng ƒë·∫øn v·ªõi VOZ Forum
                </div>
                <div style="font-size: var(--text-xs); opacity: 0.9;">
                    C·ªông ƒë·ªìng th·∫£o lu·∫≠n c√¥ng ngh·ªá, tin t·ª©c
                </div>
            </div>
            <div style="display: flex; gap: var(--space-2); flex-shrink: 0;">
                <a href="{% url 'accounts:register' %}" class="btn btn-success btn-sm" style="white-space: nowrap;">
                    üìù ƒêƒÉng k√Ω
                </a>
                <a href="{% url 'accounts:login' %}" class="btn btn-outline btn-sm" style="border-color: white; color: white; white-space: nowrap;">
                    üîê ƒêƒÉng nh·∫≠p
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Layout -->
    <div style="display: grid; grid-template-columns: 1fr 320px; gap: var(--space-6);">
    
    @media (max-width: 1024px) {
        <style>
        .sidebar-container {
            display: none;
        }
        .main-content-grid {
            grid-template-columns: 1fr !important;
        }
        </style>
    }
        
        <!-- Main Content -->
        <div class="main-content-grid">
            {% for category in categories %}
            <div class="card" style="margin-bottom: var(--space-4);">
                <div class="card-header" style="background: white; border-bottom: 2px solid var(--gray-200); padding: var(--space-4) var(--space-5);">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <h2 style="margin: 0; display: flex; align-items: center; gap: var(--space-2); font-size: var(--text-xl); font-weight: 600;">
                            <span style="font-size: 1.5rem;">{{ category.icon|default:"üìÅ" }}</span>
                            {{ category.title }}
                        </h2>
                        {% if category.sub_forums.all.count %}
                        <span class="badge badge-gray">
                            {{ category.sub_forums.all.count }} chuy√™n m·ª•c
                        </span>
                        {% endif %}
                    </div>
                    {% if category.description %}
                    <p style="margin-top: var(--space-1); margin-bottom: 0; font-size: var(--text-xs); color: var(--gray-600);">
                        {{ category.description }}
                    </p>
                    {% endif %}
                </div>
                
                <div>
                    {% if category.sub_forums.all %}
                        {% for subforum in category.sub_forums.all %}
                        <a href="{% url 'forum:category_view' subforum.slug %}" class="forum-row" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: var(--space-3); padding: var(--space-4) var(--space-5); border-bottom: 1px solid var(--gray-200); transition: background var(--transition-base);">
                            <!-- Icon -->
                            <div style="font-size: 2rem; flex-shrink: 0;">
                                {{ subforum.icon|default:"üí¨" }}
                            </div>
                            
                            <!-- Content -->
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: var(--text-sm); color: var(--gray-900); margin-bottom: 2px;">
                                    {{ subforum.title }}
                                </div>
                                {% if subforum.description %}
                                <div style="font-size: var(--text-xs); color: var(--gray-600); margin-bottom: var(--space-1);">
                                    {{ subforum.description|truncatewords:10 }}
                                </div>
                                {% endif %}
                                <div style="display: flex; gap: var(--space-3); font-size: var(--text-xs); color: var(--gray-500);">
                                    <span>üí¨ {{ subforum.thread_count }}</span>
                                    <span>üìù {{ subforum.post_count }}</span>
                                </div>
                            </div>
                            
                            <!-- Latest Post -->
                            <div style="width: 200px; flex-shrink: 0; display: none;">
                                {% with latest=subforum.latest_post %}
                                {% if latest %}
                                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                                        <div class="avatar avatar-sm">
                                            <img src="https://ui-avatars.com/api/?name={{ latest.author.username }}&background=1e5a8e&color=fff" alt="{{ latest.author.username }}">
                                        </div>
                                        <div style="min-width: 0; flex: 1;">
                                            <div style="font-size: var(--text-xs); font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                {{ latest.thread.title|truncatewords:5 }}
                                            </div>
                                            <div style="font-size: var(--text-xs); color: var(--gray-500);">
                                                {{ latest.author.username }} ‚Ä¢ {{ latest.created_at|timesince }}
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div style="font-size: var(--text-xs); color: var(--gray-500);">Ch∆∞a c√≥ b√†i vi·∫øt</div>
                                {% endif %}
                                {% endwith %}
                            </div>
                        </a>
                        {% endfor %}
                    {% else %}
                        <a href="{% url 'forum:category_view' category.slug %}" class="flex items-center gap-4 p-6 hover:bg-gray-50" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: var(--space-4); padding: var(--space-5);">
                            <div style="font-size: 2.5rem;">{{ category.icon|default:"üìù" }}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: var(--space-1);">{{ category.title }}</div>
                                <div class="text-small text-muted">
                                    {{ category.thread_count }} ch·ªß ƒë·ªÅ ‚Ä¢ {{ category.post_count }} b√†i vi·∫øt
                                </div>
                            </div>
                        </a>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <div class="empty-state-title">Ch∆∞a c√≥ danh m·ª•c n√†o</div>
                <div class="empty-state-message">H√£y quay l·∫°i sau!</div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar-container">
            <!-- Quick Stats -->
            <div class="card mb-6">
                <div class="card-header">
                    <h3 class="heading-4" style="margin: 0;">üìä Th·ªëng k√™</h3>
                </div>
                <div class="card-body">
                    <div class="flex flex-col gap-4">
                        <div>
                            <div class="text-3xl" style="font-weight: 700; color: var(--primary-500);">
                                {{ total_threads|default:"0" }}
                            </div>
                            <div class="text-small text-muted">Ch·ªß ƒë·ªÅ</div>
                        </div>
                        <div>
                            <div class="text-3xl" style="font-weight: 700; color: var(--success-500);">
                                {{ total_posts|default:"0" }}
                            </div>
                            <div class="text-small text-muted">B√†i vi·∫øt</div>
                        </div>
                        <div>
                            <div class="text-3xl" style="font-weight: 700; color: var(--warning-500);">
                                {{ total_members|default:"0" }}
                            </div>
                            <div class="text-small text-muted">Th√†nh vi√™n</div>
                        </div>
                        {% if latest_member %}
                        <div class="divider" style="margin: var(--space-3) 0;"></div>
                        <div>
                            <div class="text-xs text-muted mb-2">Th√†nh vi√™n m·ªõi nh·∫•t:</div>
                            <div class="flex items-center gap-2">
                                <div class="avatar avatar-sm">
                                    <img src="https://ui-avatars.com/api/?name={{ latest_member.username }}&background=1e5a8e&color=fff" alt="{{ latest_member.username }}">
                                </div>
                                <span class="text-small" style="font-weight: 600;">{{ latest_member.username }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Trending Content -->
            <div class="card mb-6">
                <div class="card-header">
                    <h3 class="heading-4" style="margin: 0;">üî• Trending</h3>
                </div>
                <div style="divide-y divide-gray-200;">
                    {% for thread in featured_threads %}
                    <a href="{% url 'forum:thread_detail' thread.id %}" class="flex gap-3 p-4 hover:bg-gray-50" style="text-decoration: none; color: inherit; display: flex; gap: var(--space-3); padding: var(--space-4);">
                        <div class="avatar avatar-sm">
                            <img src="https://ui-avatars.com/api/?name={{ thread.author.username }}&background=1e5a8e&color=fff" alt="">
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div class="text-small" style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                {{ thread.title }}
                            </div>
                            <div class="text-xs text-muted mt-1">
                                {{ thread.author.username }} ‚Ä¢ üëÅ {{ thread.views }}
                            </div>
                        </div>
                    </a>
                    {% empty %}
                    <div class="p-4 text-center text-muted text-small">
                        Ch∆∞a c√≥ n·ªôi dung trending
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Latest Posts -->
            <div class="card">
                <div class="card-header">
                    <h3 class="heading-4" style="margin: 0;">üìù B√†i vi·∫øt m·ªõi</h3>
                </div>
                <div style="divide-y divide-gray-200;">
                    {% for post in latest_posts %}
                    <a href="{% url 'forum:thread_detail' post.thread.id %}" class="flex gap-3 p-4 hover:bg-gray-50" style="text-decoration: none; color: inherit; display: flex; gap: var(--space-3); padding: var(--space-4);">
                        <div class="avatar avatar-sm">
                            <img src="https://ui-avatars.com/api/?name={{ post.author.username }}&background=2d8f3c&color=fff" alt="">
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div class="text-small" style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                {{ post.thread.title }}
                            </div>
                            <div class="text-xs text-muted mt-1">
                                {{ post.author.username }} ‚Ä¢ {{ post.created_at|timesince }}
                            </div>
                        </div>
                    </a>
                    {% empty %}
                    <div class="p-4 text-center text-muted text-small">
                        Ch∆∞a c√≥ b√†i vi·∫øt m·ªõi
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.forum-row:hover {
    background-color: var(--gray-50) !important;
}

.forum-row:last-child {
    border-bottom: none !important;
}

@media (min-width: 1200px) {
    .forum-row > div:last-child {
        display: block !important;
    }
}

@media (max-width: 1024px) {
    .sidebar-container {
        display: none !important;
    }
}

@media (max-width: 640px) {
    .container {
        padding: 0 var(--space-2) !important;
    }
    
    .card-header h2 {
        font-size: var(--text-base) !important;
    }
    
    .forum-row {
        padding: var(--space-3) !important;
    }
}
</style>
{% endblock %}
